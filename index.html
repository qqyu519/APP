<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ç¨‹å¤§ç®¡å®¶ - åˆ†å¸³é¡åˆ¥å¼·åŒ–ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
            padding-bottom: 120px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        :root { --primary: #ffb7c5; }

        .kawaii-header { 
            border-radius: 0 0 40px 40px; 
            background: linear-gradient(135deg, var(--primary), #ffffff); 
        }

        .tab-btn { color: #94a3b8; transition: all 0.3s; font-size: 11px; font-weight: 800; padding: 10px 18px; border-radius: 999px; }
        .tab-btn.active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(255, 183, 197, 0.4); }
        
        .day-tab-btn { 
            font-size: 13px; padding: 8px 20px; border-radius: 18px; font-weight: 800; transition: all 0.2s; flex-shrink: 0;
        }
        .day-tab-btn.active { background-color: var(--primary); color: white; transform: translateY(-2px); }

        .modal-bg { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(8px); 
            z-index: 9999; 
            position: fixed; 
            inset: 0; 
            display: none; 
            align-items: flex-end; 
            justify-content: center; 
        }
        
        .animate-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* è¡Œç¨‹é¡åˆ¥é‚Šæ¡†é…è‰² */
        .card-spot { border-left: 6px solid #fb7185; }
        .card-transit { border-left: 6px solid #3b82f6; background-color: #eff6ff !important; }
        .card-food { border-left: 6px solid #fbbf24; }
        .card-hotel { border-left: 6px solid #8b5cf6; }
        .card-gift { border-left: 6px solid #d946ef; }
        .card-shrine { border-left: 6px solid #e11d48; }
        .card-park { border-left: 6px solid #f97316; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .currency-btn.active { background-color: white; color: var(--primary); font-weight: 900; }
        
        .timeline-connector {
            position: absolute;
            left: 28px;
            top: 60px;
            bottom: -20px;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }
    </style>
</head>
<body>

    <!-- å·¥å…·åˆ— -->
    <div class="fixed top-2 left-0 right-0 z-50 flex justify-between px-4 pointer-events-none">
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="exportData()" class="bg-white/40 backdrop-blur-md text-gray-700 text-[10px] px-3 py-1.5 rounded-full font-bold">å‚™ä»½</button>
            <button onclick="document.getElementById('file-input').click()" class="bg-white/40 backdrop-blur-md text-gray-700 text-[10px] px-3 py-1.5 rounded-full font-bold">é‚„åŸ</button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(event)">
        </div>
        <button onclick="resetSystem()" class="bg-red-500/10 backdrop-blur-md text-red-500 text-[10px] px-3 py-1.5 rounded-full font-bold pointer-events-auto">é‡ç½®</button>
    </div>

    <header id="header-bg" class="kawaii-header pt-16 pb-12 px-6 text-center shadow-md">
        <div class="inline-block px-6 py-2 rounded-3xl cursor-pointer" id="header-trigger">
            <h1 id="main-title-display" class="text-3xl font-black text-white tracking-widest uppercase mb-1">Tokyo</h1>
            <div class="flex items-center justify-center gap-2 text-white/90">
                <p id="sub-title-display" class="text-xs font-bold tracking-widest uppercase italic">Travel Diary</p>
                <i class="fas fa-pen-nib text-[10px]"></i>
            </div>
        </div>
    </header>

    <nav class="flex justify-center -mt-7 relative z-20 px-4">
        <div class="bg-white p-1.5 rounded-full shadow-xl flex space-x-1 overflow-x-auto no-scrollbar max-w-full">
            <button onclick="switchTab('itinerary')" id="nav-itinerary" class="tab-btn active">ğŸ—“ï¸ è¡Œç¨‹</button>
            <button onclick="switchTab('todo')" id="nav-todo" class="tab-btn">ğŸ“ æ¸…å–®</button>
            <button onclick="switchTab('billing')" id="nav-billing" class="tab-btn">ğŸ’° åˆ†å¸³</button>
            <button onclick="switchTab('analysis')" id="nav-analysis" class="tab-btn">ğŸ“Š åˆ†æ</button>
        </div>
    </nav>

    <main class="mt-8 px-4 max-w-md mx-auto">
        <!-- è¡Œç¨‹é é¢ -->
        <section id="sec-itinerary" class="page-section space-y-5">
            <div id="day-bar" class="flex space-x-3 overflow-x-auto py-2 no-scrollbar px-1"></div>
            <div id="itinerary-list" class="space-y-6 relative"></div>
            <div class="grid grid-cols-2 gap-3 pt-6">
                <button onclick="prepareAdd('spot')" class="py-4 bg-white border-2 border-dashed border-slate-200 text-slate-400 rounded-3xl font-bold text-xs shadow-sm">
                    <i class="fas fa-plus-circle mr-1"></i> æ–°å¢è¡Œç¨‹
                </button>
                <button onclick="prepareAdd('transit')" class="py-4 bg-blue-50 border-2 border-dashed border-blue-200 text-blue-400 rounded-3xl font-bold text-xs shadow-sm">
                    <i class="fas fa-train mr-1"></i> æ–°å¢äº¤é€š
                </button>
            </div>
        </section>

        <!-- åˆ†å¸³é é¢ -->
        <section id="sec-billing" class="page-section hidden space-y-6">
            <!-- åŒ¯ç‡èˆ‡æˆå“¡ -->
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm space-y-4 border border-slate-50">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Rate & Members</span>
                    <button onclick="openMemberM()" class="text-pink-400 text-[11px] font-black underline">ç·¨è¼¯æˆå“¡</button>
                </div>
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl">
                    <span class="text-xs font-bold text-slate-500">1 JPY =</span>
                    <input id="exchange-rate-input" type="number" step="0.001" onchange="updateRate(this.value)" class="flex-1 bg-white border-none rounded-xl py-2 text-center text-sm font-black text-pink-500 shadow-inner outline-none">
                    <span class="text-xs font-bold text-slate-500">TWD</span>
                </div>
            </div>

            <!-- è¨˜å¸³è¡¨å–® -->
            <div class="bg-white p-6 rounded-[2.5rem] shadow-md border-t-8 border-pink-100 space-y-5">
                <div class="flex justify-between items-center">
                    <h3 id="bill-form-title" class="font-black text-slate-700">ğŸ’¸ è¨˜ä¸€ç­†å¸³</h3>
                    <div class="bg-slate-100 p-1 rounded-xl flex">
                        <button onclick="setCurrency('JPY')" id="btn-cur-jpy" class="currency-btn px-4 py-1.5 rounded-lg text-[10px]">JPY</button>
                        <button onclick="setCurrency('TWD')" id="btn-cur-twd" class="currency-btn px-4 py-1.5 rounded-lg text-[10px]">TWD</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <select id="bill-payer" class="w-full bg-slate-50 rounded-2xl p-4 text-xs font-bold outline-none"></select>
                    <select id="bill-cat" class="w-full bg-slate-50 rounded-2xl p-4 text-xs font-bold outline-none">
                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                        <option value="transit">ğŸšŒ äº¤é€š</option>
                        <option value="gift">ğŸ›ï¸ ä¼´æ‰‹ç¦®</option>
                        <option value="spot">ğŸŸï¸ é–€ç¥¨/æ™¯é»</option>
                        <option value="hotel">ğŸ¨ ä½å®¿</option>
                        <option value="other">ğŸ“¦ å…¶ä»–</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <input id="bill-desc" type="text" placeholder="é …ç›®åç¨±" class="col-span-2 p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none">
                    <input id="bill-amount" type="number" placeholder="é‡‘é¡" class="col-span-1 bg-slate-50 rounded-2xl p-4 text-xs font-black outline-none">
                </div>

                <div id="split-display" class="flex flex-wrap gap-2 px-1"></div>
                
                <div class="flex gap-2">
                    <button onclick="cancelBillEdit()" id="btn-cancel-edit" class="hidden flex-1 py-4 bg-slate-100 text-slate-400 rounded-2xl font-bold text-sm">å–æ¶ˆ</button>
                    <button onclick="saveBill()" class="flex-[2] py-4 bg-pink-400 text-white rounded-2xl font-black text-sm shadow-lg">å„²å­˜æ”¯å‡º</button>
                </div>
            </div>

            <div id="settlement-container" class="space-y-4">
                <h3 class="font-black text-slate-700 text-sm px-2">ğŸ’° çµç®—å»ºè­°</h3>
                <div id="settlement-display" class="space-y-3"></div>
            </div>

            <div id="bill-history" class="space-y-3 pb-10"></div>
        </section>

        <!-- åˆ†æé é¢ -->
        <section id="sec-analysis" class="page-section hidden space-y-6">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm text-center">
                <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-4">Total Spending</h3>
                <div class="space-y-1">
                    <div class="text-3xl font-black text-slate-800" id="total-twd-display">$0 <span class="text-xs">TWD</span></div>
                    <div class="text-xs font-bold text-slate-400" id="total-jpy-display">0 JPY</div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- æˆå“¡ä½”æ¯”åœ– -->
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm">
                    <h3 class="text-sm font-black text-slate-700 mb-6 text-center">æˆå“¡æ”¯å‡ºæ¯”ä¾‹</h3>
                    <div class="aspect-square max-w-[180px] mx-auto">
                        <canvas id="analysis-chart-member"></canvas>
                    </div>
                    <div class="mt-6 space-y-2" id="member-stats-list"></div>
                </div>

                <!-- åˆ†é¡ä½”æ¯”åœ– -->
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm">
                    <h3 class="text-sm font-black text-slate-700 mb-6 text-center">æ¶ˆè²»åˆ†é¡çµ±è¨ˆ</h3>
                    <div class="aspect-square max-w-[180px] mx-auto">
                        <canvas id="analysis-chart-category"></canvas>
                    </div>
                    <div class="mt-6 space-y-2" id="category-stats-list"></div>
                </div>
            </div>
        </section>

        <!-- å¾…è¾¦æ¸…å–® -->
        <section id="sec-todo" class="page-section hidden space-y-4">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm flex gap-3">
                <input id="todo-input" type="text" placeholder="æ–°å¢å¾…è¾¦é …ç›®..." class="flex-1 bg-slate-50 rounded-2xl px-4 text-sm font-bold outline-none">
                <button onclick="addTodo()" class="bg-pink-400 text-white px-6 py-3 rounded-2xl font-black text-sm">ï¼‹</button>
            </div>
            <div id="todo-list" class="space-y-2"></div>
        </section>
    </main>

    <!-- å½ˆçª— -->
    <div id="it-modal" class="modal-bg" onclick="if(event.target===this)closeM('it-modal')">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-8 space-y-5 animate-up overflow-y-auto max-h-[90vh] no-scrollbar">
            <div class="flex justify-between items-center">
                <h3 id="it-modal-title" class="font-black text-2xl text-slate-800">è¦åŠƒè¡Œç¨‹</h3>
                <button onclick="closeM('it-modal')" class="text-slate-300 p-2"><i class="fas fa-times"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 ml-1">æ™‚é–“</label>
                    <input id="it-time" type="time" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none shadow-inner">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 ml-1">é¡åˆ¥</label>
                    <select id="it-type" onchange="toggleTransitUI()" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none shadow-inner">
                        <option value="spot">ğŸš© æ™¯é»</option>
                        <option value="shrine">â›©ï¸ ç¥ç¤¾</option>
                        <option value="park">ğŸ¡ éŠæ¨‚åœ’</option>
                        <option value="gift">ğŸ›ï¸ ä¼´æ‰‹ç¦®</option>
                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                        <option value="hotel">ğŸ¨ ä½å®¿</option>
                        <option value="transit">ğŸšŒ äº¤é€š</option>
                    </select>
                </div>
            </div>
            <div id="ui-spot-fields" class="space-y-4">
                <input id="it-title" type="text" placeholder="è¡Œç¨‹åç¨±" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-black outline-none shadow-inner">
                <input id="it-location" type="text" placeholder="åœ°é»é—œéµå­— (åœ°åœ–ç”¨)" class="w-full p-4 bg-slate-50 rounded-2xl text-sm outline-none shadow-inner">
            </div>
            <div id="ui-transit-fields" class="hidden p-5 bg-blue-50/50 rounded-3xl space-y-4">
                <input id="it-station" type="text" placeholder="è·¯ç·šåç¨±" class="w-full p-4 bg-white rounded-2xl text-sm font-bold outline-none shadow-sm">
                <div class="grid grid-cols-2 gap-3">
                    <input id="it-duration" type="text" placeholder="æ™‚é–“(åˆ†)" class="w-full p-4 bg-white rounded-2xl text-sm outline-none shadow-sm">
                    <input id="it-cost" type="number" placeholder="è»Šè³‡ JPY" class="w-full p-4 bg-white rounded-2xl text-sm font-black text-blue-500 outline-none shadow-sm">
                </div>
            </div>
            <textarea id="it-note" placeholder="è©³ç´°å‚™è¨»..." class="w-full p-4 bg-slate-50 rounded-2xl text-sm h-32 outline-none shadow-inner"></textarea>
            <div class="flex gap-3">
                <button id="btn-delete-it" onclick="handleDeleteIt()" class="hidden bg-red-50 text-red-500 px-6 rounded-2xl font-black text-xs">åˆªé™¤</button>
                <button onclick="handleSaveIt()" class="flex-1 py-5 bg-pink-400 text-white rounded-[1.5rem] font-black shadow-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="member-modal" class="modal-bg" onclick="if(event.target===this)closeM('member-modal')">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-5 animate-up mb-20">
            <h3 class="font-black text-xl">æˆå“¡ç®¡ç†</h3>
            <div class="flex gap-2">
                <input id="member-new-name" type="text" placeholder="å§“å" class="flex-1 p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none">
                <button onclick="addMember()" class="bg-pink-400 text-white px-6 rounded-2xl font-black text-xs">æ–°å¢</button>
            </div>
            <div id="member-edit-list" class="max-h-52 overflow-y-auto no-scrollbar"></div>
            <button onclick="closeM('member-modal')" class="w-full py-4 bg-slate-100 rounded-2xl font-bold text-slate-400">é—œé–‰</button>
        </div>
    </div>

    <div id="title-modal" class="modal-bg" onclick="if(event.target===this)closeM('title-modal')">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-5 animate-up mb-20">
            <h3 class="font-black text-xl">ç·¨è¼¯æ—…ç¨‹è³‡è¨Š</h3>
            <div class="space-y-4">
                <input id="input-main-title" type="text" class="w-full p-4 bg-slate-50 rounded-2xl text-lg font-black outline-none shadow-inner">
                <input id="input-sub-title" type="text" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none shadow-inner">
                <input id="input-theme-color" type="color" class="w-full h-12 bg-slate-50 rounded-2xl p-1 outline-none shadow-inner">
            </div>
            <button onclick="saveTitles()" class="w-full py-4 bg-pink-400 text-white rounded-2xl font-black">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        let state = {
            themeColor: '#ffb7c5',
            mainTitle: "TOKYO",
            subTitle: "Travel Diary",
            selectedDay: 1,
            currency: 'JPY',
            exchangeRate: 0.215,
            members: ["æˆ‘", "å¤¥ä¼´"],
            itinerary: [],
            bills: [],
            todos: [],
            editingItId: null,
            editingBillId: null
        };

        let chartMember = null;
        let chartCategory = null;
        const STORAGE_KEY = 'TRIP_MASTER_FINAL_FIXED_V7';
        
        const CAT_ICONS = { 
            food: "ğŸ´", transit: "ğŸšŒ", gift: "ğŸ›ï¸", spot: "ğŸŸï¸", hotel: "ğŸ¨", other: "ğŸ“¦", shrine: "â›©ï¸", park: "ğŸ¡"
        };

        const CAT_LABELS = {
            food: "ç¾é£Ÿ", transit: "äº¤é€š", gift: "ä¼´æ‰‹ç¦®", spot: "é–€ç¥¨/æ™¯é»", hotel: "ä½å®¿", other: "å…¶ä»–", shrine: "ç¥ç¤¾", park: "éŠæ¨‚åœ’"
        };

        const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        const load = () => {
            const s = localStorage.getItem(STORAGE_KEY);
            if(s) state = Object.assign(state, JSON.parse(s));
        };

        const closeM = (id) => document.getElementById(id).style.display = 'none';
        const openM = (id) => document.getElementById(id).style.display = 'flex';

        const toggleTransitUI = () => {
            const type = document.getElementById('it-type').value;
            document.getElementById('ui-transit-fields').classList.toggle('hidden', type !== 'transit');
            document.getElementById('ui-spot-fields').classList.toggle('hidden', type === 'transit');
        };

        const render = () => {
            save();
            document.documentElement.style.setProperty('--primary', state.themeColor);
            document.getElementById('header-bg').style.background = `linear-gradient(135deg, ${state.themeColor}, #ffffff)`;
            document.getElementById('main-title-display').innerText = state.mainTitle;
            document.getElementById('sub-title-display').innerText = state.subTitle;
            document.getElementById('exchange-rate-input').value = state.exchangeRate;

            // è¡Œç¨‹æ¸²æŸ“
            document.getElementById('day-bar').innerHTML = Array.from({length: 12}, (_, i) => i + 1).map(d => `
                <button onclick="state.selectedDay=${d};render()" class="day-tab-btn shadow-sm ${state.selectedDay===d?'active':'bg-white text-slate-300'}">Day ${d}</button>
            `).join('');

            const its = state.itinerary.filter(i => i.day === state.selectedDay).sort((a,b)=>a.time.localeCompare(b.time));
            document.getElementById('itinerary-list').innerHTML = its.map((i, idx) => {
                const mapUrl = i.location ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location)}` : null;
                return `
                <div class="relative">
                    ${idx < its.length - 1 ? '<div class="timeline-connector"></div>' : ''}
                    <div onclick="editIt(${i.id})" class="itinerary-card card-${i.type} bg-white p-5 rounded-[2.2rem] shadow-sm flex gap-4 animate-up relative z-10 active:scale-[0.98] transition-all">
                        <div class="min-w-[55px] text-center border-r border-slate-50 pr-2">
                            <div class="text-[14px] font-black text-slate-700">${i.time}</div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="text-[15px] font-black text-slate-800 truncate">
                                    ${i.type === 'transit' ? `ğŸšŒ ${i.station || 'æœªå‘½åäº¤é€š'}` : `${CAT_ICONS[i.type] || 'ğŸ“'} ${i.title || 'æœªå‘½åé …ç›®'}`}
                                </div>
                                ${mapUrl ? `<a href="${mapUrl}" target="_blank" onclick="event.stopPropagation();" class="text-sky-400 bg-sky-50 w-8 h-8 rounded-full flex items-center justify-center shadow-sm"><i class="fas fa-map-marked-alt text-xs"></i></a>` : ''}
                            </div>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${i.duration ? `<span class="text-[9px] text-blue-500 font-black bg-blue-50 px-2 py-0.5 rounded-lg">${i.duration} åˆ†</span>` : ''}
                                ${i.cost ? `<span class="text-[9px] text-emerald-500 font-black bg-emerald-50 px-2 py-0.5 rounded-lg">${i.cost} JPY</span>` : ''}
                            </div>
                            ${i.note ? `<div class="mt-3 p-3 bg-slate-50 rounded-2xl text-[11px] text-slate-500 font-medium">${i.note.replace(/\n/g, '<br>')}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('') || `<div class="py-16 text-center text-slate-300 font-black opacity-40 text-[10px]">Ready to go!</div>`;

            // åˆ†å¸³é é¢æ¸²æŸ“
            document.getElementById('bill-payer').innerHTML = state.members.map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('split-display').innerHTML = state.members.map(m => `
                <label class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-2xl text-[10px] font-black cursor-pointer border-2 border-transparent has-[:checked]:border-pink-200 has-[:checked]:bg-white">
                    <input type="checkbox" name="split-item" value="${m}" checked class="w-4 h-4 rounded accent-pink-400"> ${m}
                </label>`).join('');

            document.getElementById('bill-history').innerHTML = state.bills.slice().reverse().map(b => `
                <div onclick="editBill(${b.id})" class="bg-white p-4 rounded-3xl flex justify-between items-center shadow-sm border border-slate-50 mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-lg">${CAT_ICONS[b.category] || 'ğŸ’°'}</div>
                        <div>
                            <div class="text-[12px] font-black text-slate-700">${b.desc}</div>
                            <div class="text-[9px] text-slate-400 font-bold">${b.payer} æ”¯ä»˜ | ${CAT_LABELS[b.category]}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-pink-500 text-sm">$${Math.round(b.twd)} <span class="text-[8px]">TWD</span></div>
                    </div>
                </div>`).join('');

            // å¾…è¾¦æ¸²æŸ“
            document.getElementById('todo-list').innerHTML = state.todos.map((t, idx) => `
                <div class="bg-white p-4 rounded-3xl flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo(${idx})" class="w-5 h-5 accent-pink-400">
                        <span class="text-sm font-bold ${t.done?'line-through text-slate-300':'text-slate-700'}">${t.text}</span>
                    </div>
                    <button onclick="deleteTodo(${idx})" class="text-slate-200"><i class="fas fa-trash-alt text-xs"></i></button>
                </div>`).join('');

            updateSettlement();
            updateAnalysis();
        };

        const updateAnalysis = () => {
            const totalTwd = state.bills.reduce((sum, b) => sum + b.twd, 0);
            const totalJpy = state.bills.reduce((sum, b) => sum + (b.currency === 'JPY' ? b.amount : 0), 0);
            document.getElementById('total-twd-display').innerHTML = `$${Math.round(totalTwd).toLocaleString()} <span class="text-xs">TWD</span>`;
            document.getElementById('total-jpy-display').innerText = `${Math.round(totalJpy).toLocaleString()} JPY`;

            // æˆå“¡çµ±è¨ˆ
            const memberData = {};
            state.members.forEach(m => memberData[m] = 0);
            state.bills.forEach(b => { if(memberData[b.payer] !== undefined) memberData[b.payer] += b.twd; });
            
            document.getElementById('member-stats-list').innerHTML = Object.entries(memberData).map(([name, val]) => `
                <div class="flex justify-between text-[11px] font-bold text-slate-500">
                    <span>${name}</span>
                    <span>$${Math.round(val).toLocaleString()}</span>
                </div>
            `).join('');

            // åˆ†é¡çµ±è¨ˆ
            const catData = {};
            state.bills.forEach(b => {
                catData[b.category] = (catData[b.category] || 0) + b.twd;
            });

            document.getElementById('category-stats-list').innerHTML = Object.entries(catData).map(([cat, val]) => `
                <div class="flex justify-between text-[11px] font-bold text-slate-500">
                    <span>${CAT_ICONS[cat]} ${CAT_LABELS[cat]}</span>
                    <span>$${Math.round(val).toLocaleString()}</span>
                </div>
            `).join('');

            // åœ–è¡¨æ¸²æŸ“
            const createChart = (ctxId, labels, data, palette) => {
                const ctx = document.getElementById(ctxId).getContext('2d');
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data, backgroundColor: palette, borderWidth: 0 }] },
                    options: { plugins: { legend: { display: false } }, cutout: '75%', responsive: true }
                });
            };

            const palette = ['#ffb7c5', '#94a3b8', '#3b82f6', '#fbbf24', '#8b5cf6', '#d946ef', '#10b981'];
            if (chartMember) chartMember.destroy();
            chartMember = createChart('analysis-chart-member', Object.keys(memberData), Object.values(memberData), palette);

            if (chartCategory) chartCategory.destroy();
            chartCategory = createChart('analysis-chart-category', Object.keys(catData).map(k => CAT_LABELS[k]), Object.values(catData), palette.slice().reverse());
        };

        const updateSettlement = () => {
            const balances = {}; 
            state.members.forEach(m => balances[m] = 0);
            state.bills.forEach(b => {
                const sers = b.splitters.filter(s => state.members.includes(s));
                if(sers.length === 0) return;
                const share = b.twd / sers.length;
                if(balances[b.payer] !== undefined) balances[b.payer] += b.twd;
                sers.forEach(s => balances[s] -= share);
            });
            let debtors = [], creditors = [];
            Object.keys(balances).forEach(m => {
                if(balances[m] < -1) debtors.push({n: m, a: Math.abs(balances[m])});
                else if(balances[m] > 1) creditors.push({n: m, a: balances[m]});
            });
            const results = [];
            let i = 0, j = 0;
            while(i < debtors.length && j < creditors.length) {
                const payAmt = Math.min(debtors[i].a, creditors[j].a);
                results.push(`<div class="bg-white p-5 rounded-[2rem] flex justify-between items-center shadow-md animate-up"><div class="text-xs font-black">${debtors[i].n} <i class="fas fa-arrow-right mx-2 text-pink-300"></i> ${creditors[j].n}</div><div class="font-black text-pink-500">$${Math.round(payAmt).toLocaleString()}</div></div>`);
                debtors[i].a -= payAmt; creditors[j].a -= payAmt;
                if(debtors[i].a < 1) i++; if(creditors[j].a < 1) j++;
            }
            document.getElementById('settlement-display').innerHTML = results.join('') || `<div class="p-4 text-center text-slate-300 font-black text-[10px]">ğŸ’° å·²å…¨æ•¸æ¸…ç©º</div>`;
        };

        // åŠŸèƒ½æ€§å‡½æ•¸
        const switchTab = (id) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
        };

        const prepareAdd = (type) => {
            state.editingItId = null;
            document.getElementById('it-type').value = type;
            ['it-title', 'it-location', 'it-station', 'it-duration', 'it-cost', 'it-note'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('it-time').value = "09:00";
            document.getElementById('btn-delete-it').classList.add('hidden');
            toggleTransitUI(); openM('it-modal');
        };

        const editIt = (id) => {
            const i = state.itinerary.find(x => x.id === id);
            state.editingItId = id;
            document.getElementById('it-type').value = i.type;
            document.getElementById('it-time').value = i.time;
            document.getElementById('it-title').value = i.title || "";
            document.getElementById('it-location').value = i.location || "";
            document.getElementById('it-station').value = i.station || "";
            document.getElementById('it-duration').value = i.duration || "";
            document.getElementById('it-cost').value = i.cost || "";
            document.getElementById('it-note').value = i.note || "";
            document.getElementById('btn-delete-it').classList.remove('hidden');
            toggleTransitUI(); openM('it-modal');
        };

        const handleSaveIt = () => {
            const data = {
                id: state.editingItId || Date.now(),
                day: state.selectedDay,
                type: document.getElementById('it-type').value,
                time: document.getElementById('it-time').value,
                title: document.getElementById('it-title').value,
                location: document.getElementById('it-location').value,
                station: document.getElementById('it-station').value,
                duration: document.getElementById('it-duration').value,
                cost: parseFloat(document.getElementById('it-cost').value) || 0,
                note: document.getElementById('it-note').value
            };
            if(state.editingItId) state.itinerary = state.itinerary.map(x => x.id === data.id ? data : x);
            else state.itinerary.push(data);
            closeM('it-modal'); render();
        };

        const handleDeleteIt = () => { if(confirm("åˆªé™¤è¡Œç¨‹ï¼Ÿ")){ state.itinerary = state.itinerary.filter(x => x.id !== state.editingItId); closeM('it-modal'); render(); }};

        const updateRate = (v) => { state.exchangeRate = parseFloat(v); render(); };
        const setCurrency = (c) => { state.currency = c; render(); };
        
        const saveBill = () => {
            const amt = parseFloat(document.getElementById('bill-amount').value);
            const desc = document.getElementById('bill-desc').value.trim();
            const cat = document.getElementById('bill-cat').value;
            const sers = Array.from(document.querySelectorAll('input[name="split-item"]:checked')).map(i => i.value);
            if(!amt || !desc || !sers.length) return;
            
            const billData = {
                id: state.editingBillId || Date.now(),
                amount: amt, desc, category: cat, currency: state.currency,
                twd: state.currency === 'JPY' ? amt * state.exchangeRate : amt,
                payer: document.getElementById('bill-payer').value,
                splitters: sers
            };
            
            if(state.editingBillId) state.bills = state.bills.map(x => x.id === state.editingBillId ? billData : x);
            else state.bills.push(billData);
            cancelBillEdit();
        };

        const editBill = (id) => {
            const b = state.bills.find(x => x.id === id);
            state.editingBillId = id;
            document.getElementById('bill-amount').value = b.amount;
            document.getElementById('bill-desc').value = b.desc;
            document.getElementById('bill-payer').value = b.payer;
            document.getElementById('bill-cat').value = b.category || 'other';
            state.currency = b.currency;
            document.querySelectorAll('input[name="split-item"]').forEach(c => c.checked = b.splitters.includes(c.value));
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            render();
        };

        const cancelBillEdit = () => {
            state.editingBillId = null;
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('bill-amount').value = "";
            document.getElementById('bill-desc').value = "";
            render();
        };

        const addTodo = () => {
            const i = document.getElementById('todo-input');
            if(i.value.trim()){ state.todos.push({text: i.value, done: false}); i.value=""; render(); }
        };
        const toggleTodo = (idx) => { state.todos[idx].done = !state.todos[idx].done; render(); };
        const deleteTodo = (idx) => { state.todos.splice(idx, 1); render(); };

        const exportData = () => {
            const b = new Blob([JSON.stringify(state)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `TripBackup.json`; a.click();
        };
        const importData = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => { try { state = JSON.parse(ev.target.result); render(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } };
            r.readAsText(f);
        };
        const resetSystem = () => { if(confirm("æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); }};

        document.getElementById('header-trigger').onclick = () => {
            document.getElementById('input-main-title').value = state.mainTitle;
            document.getElementById('input-sub-title').value = state.subTitle;
            document.getElementById('input-theme-color').value = state.themeColor;
            openM('title-modal');
        };
        const saveTitles = () => {
            state.mainTitle = document.getElementById('input-main-title').value.toUpperCase();
            state.subTitle = document.getElementById('input-sub-title').value;
            state.themeColor = document.getElementById('input-theme-color').value;
            closeM('title-modal'); render();
        };
        const openMemberM = () => {
            document.getElementById('member-edit-list').innerHTML = state.members.map((m,i) => `
                <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl mb-2">
                    <span class="text-sm font-black text-slate-700">${m}</span>
                    <button onclick="state.members.splice(${i},1);render();openMemberM()" class="text-red-300 px-2"><i class="fas fa-user-minus"></i></button>
                </div>`).join('');
            openM('member-modal');
        };
        const addMember = () => {
            const n = document.getElementById('member-new-name').value.trim();
            if(n && !state.members.includes(n)) { state.members.push(n); document.getElementById('member-new-name').value=""; openMemberM(); render(); }
        };

        window.onload = () => { load(); render(); };
    </script>
</body>
</html>
