<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ç¨‹å¤§ç®¡å®¶ - GitHub ç›¸å®¹ç‰ˆ</title>
    
    <!-- å¤–éƒ¨è³‡æºï¼šç¢ºä¿ GitHub Pages è¼‰å…¥é †æš¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
            padding-bottom: env(safe-area-inset-bottom, 100px);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        :root { --primary: #ffb7c5; }

        /* èƒŒæ™¯è¨­è¨ˆ */
        .kawaii-header { 
            border-radius: 0 0 40px 40px; 
            background: linear-gradient(135deg, var(--primary), #ffffff); 
            transition: background 0.5s ease;
        }

        /* å°èˆªæŒ‰éˆ• */
        .tab-btn { color: #94a3b8; transition: all 0.3s; font-size: 11px; font-weight: 800; padding: 8px 16px; border-radius: 999px; }
        .tab-btn.active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(255, 183, 197, 0.4); }
        
        .day-tab-btn { 
            font-size: 13px; padding: 8px 20px; border-radius: 18px; font-weight: 800; transition: all 0.2s; flex-shrink: 0;
        }
        .day-tab-btn.active { background-color: var(--primary); color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* å½ˆçª—è¨­è¨ˆ */
        .modal-bg { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(8px); 
            z-index: 9999; 
            position: fixed; 
            inset: 0; 
            display: none; 
            align-items: flex-end; 
            justify-content: center; 
        }
        .animate-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* å¡ç‰‡é¡è‰²ç³»çµ± */
        .card-shrine { border-left: 6px solid #ef4444; }
        .card-park { border-left: 6px solid #f97316; }
        .card-food { border-left: 6px solid #fbbf24; }
        .card-spot { border-left: 6px solid #10b981; }
        .card-transit { border-left: 6px solid #3b82f6; }
        .card-hotel { border-left: 6px solid #8b5cf6; }
        .card-shop { border-left: 6px solid #ec4899; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .currency-btn.active { background-color: white; color: var(--primary); font-weight: 900; }
        
        /* ä¿®æ”¹æ¨™é¡Œç”¨çš„å°ˆç”¨æ¨£å¼ */
        #header-trigger {
            touch-action: manipulation;
            user-select: none;
        }
    </style>
</head>
<body>

    <!-- é ‚éƒ¨å·¥å…·åˆ— -->
    <div class="fixed top-2 left-0 right-0 z-50 flex justify-between px-4 pointer-events-none">
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="exportData()" class="bg-white/30 backdrop-blur-md text-gray-700 text-[10px] px-3 py-1.5 rounded-full font-bold shadow-sm">å‚™ä»½</button>
            <button onclick="document.getElementById('file-input').click()" class="bg-white/30 backdrop-blur-md text-gray-700 text-[10px] px-3 py-1.5 rounded-full font-bold shadow-sm">é‚„åŸ</button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(event)">
        </div>
        <button onclick="resetSystem()" class="bg-red-500/10 backdrop-blur-md text-red-500 text-[10px] px-3 py-1.5 rounded-full font-bold pointer-events-auto">æ¸…ç©º</button>
    </div>

    <!-- Headerï¼šé»æ“Šå¯ä¿®æ”¹æ¨™é¡Œ -->
    <header id="header-bg" class="kawaii-header pt-16 pb-12 px-6 text-center shadow-md">
        <div class="inline-block px-6 py-2 rounded-3xl transition-all active:scale-95 cursor-pointer" id="header-trigger">
            <h1 id="main-title-display" class="text-3xl font-black text-white tracking-widest drop-shadow-md uppercase mb-1">Tokyo</h1>
            <div class="flex items-center justify-center gap-2">
                <p id="sub-title-display" class="text-white/90 text-xs font-bold tracking-widest uppercase italic">Travel Diary</p>
                <i class="fas fa-edit text-white/50 text-[10px]"></i>
            </div>
        </div>
    </header>

    <!-- åˆ†é å°èˆª -->
    <nav class="flex justify-center -mt-7 relative z-20 px-4">
        <div class="bg-white p-1.5 rounded-full shadow-xl flex space-x-1 overflow-x-auto no-scrollbar max-w-full">
            <button onclick="switchTab('itinerary')" id="nav-itinerary" class="tab-btn active">ğŸ—“ï¸ è¡Œç¨‹</button>
            <button onclick="switchTab('todo')" id="nav-todo" class="tab-btn">ğŸ“ æ¸…å–®</button>
            <button onclick="switchTab('billing')" id="nav-billing" class="tab-btn">ğŸ’° åˆ†å¸³</button>
            <button onclick="switchTab('analysis')" id="nav-analysis" class="tab-btn">ğŸ“Š åˆ†æ</button>
        </div>
    </nav>

    <main class="mt-8 px-4 max-w-md mx-auto min-h-[60vh]">
        <!-- è¡Œç¨‹é é¢ -->
        <section id="sec-itinerary" class="page-section space-y-5">
            <div id="day-bar" class="flex space-x-3 overflow-x-auto py-2 no-scrollbar px-1"></div>
            <div id="itinerary-list" class="space-y-4"></div>
            <button onclick="openM('it-modal')" class="w-full py-5 bg-white border-2 border-dashed border-gray-200 text-gray-400 rounded-[2rem] font-bold text-sm shadow-sm active:scale-[0.98] transition-all">
                <i class="fas fa-plus-circle mr-2"></i>å®‰æ’æ–°è¡Œç¨‹ / äº¤é€š
            </button>
        </section>

        <!-- åˆ†å¸³é é¢ -->
        <section id="sec-billing" class="page-section hidden space-y-5">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-gray-400 text-[10px] uppercase tracking-widest">Settings</h3>
                    <button onclick="openMemberM()" class="text-pink-400 text-[11px] font-black underline underline-offset-4">ç·¨è¼¯æˆå“¡</button>
                </div>
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <span class="text-xs font-bold text-slate-500">1 JPY =</span>
                    <input id="exchange-rate-input" type="number" step="0.001" onchange="updateRate(this.value)" class="flex-1 bg-white border-none rounded-xl py-2 text-center text-sm font-black text-pink-500 shadow-inner outline-none">
                    <span class="text-xs font-bold text-slate-500">TWD</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-md border-t-8 border-pink-100 space-y-5">
                <div class="flex justify-between items-center">
                    <h3 id="bill-form-title" class="font-black text-slate-700">ğŸ’¸ æ–°å¢æ”¯å‡º</h3>
                    <div class="bg-slate-100 p-1 rounded-xl flex shadow-inner">
                        <button onclick="setCurrency('JPY')" id="btn-cur-jpy" class="currency-btn px-4 py-1.5 rounded-lg text-[10px]">JPY</button>
                        <button onclick="setCurrency('TWD')" id="btn-cur-twd" class="currency-btn px-4 py-1.5 rounded-lg text-[10px]">TWD</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="bill-payer" class="bg-slate-50 rounded-2xl p-4 text-xs font-bold outline-none border border-slate-100"></select>
                    <input id="bill-amount" type="number" placeholder="é‡‘é¡" class="bg-slate-50 rounded-2xl p-4 text-xs font-black outline-none border border-slate-100 focus:border-pink-200">
                </div>
                <input id="bill-desc" type="text" placeholder="æ”¯å‡ºé …ç›®åç¨±..." class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none border border-slate-100">
                <select id="bill-category" class="w-full bg-slate-50 rounded-2xl p-4 text-xs font-bold outline-none border border-slate-100">
                    <option value="food">ğŸ´ é£²é£Ÿç¾é£Ÿ</option>
                    <option value="transport">ğŸš— äº¤é€šè»Šè³‡</option>
                    <option value="hotel">ğŸ¨ ä½å®¿é£¯åº—</option>
                    <option value="shop">ğŸ›ï¸ è³¼ç‰©è²·è²·</option>
                    <option value="ticket">ğŸŸï¸ é–€ç¥¨æ´»å‹•</option>
                    <option value="other">ğŸ“¦ å…¶ä»–é›œé …</option>
                </select>
                <div id="split-display" class="flex flex-wrap gap-2 px-1"></div>
                <div class="flex gap-3">
                    <button onclick="cancelBillEdit()" id="btn-cancel-edit" class="hidden flex-1 py-4 bg-slate-100 text-slate-400 rounded-2xl font-bold text-sm">å–æ¶ˆ</button>
                    <button onclick="saveBill()" class="flex-[2] py-4 bg-pink-400 text-white rounded-2xl font-black text-sm shadow-lg active:scale-95 transition-all">ç¢ºèªå„²å­˜</button>
                </div>
            </div>

            <div id="settlement-display" class="space-y-3"></div>
            <div id="bill-history" class="space-y-3 pb-8"></div>
        </section>

        <!-- å¾…è¾¦æ¸…å–® -->
        <section id="sec-todo" class="page-section hidden space-y-4">
             <div class="bg-white p-6 rounded-[2rem] shadow-sm space-y-5">
                <div class="flex gap-2">
                    <input id="todo-input" type="text" placeholder="æƒ³å¸¶çš„æ±è¥¿æˆ–ä»»å‹™..." class="flex-1 p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none border border-slate-100">
                    <button onclick="addTodo()" class="bg-pink-400 text-white px-6 rounded-2xl font-black text-xs shadow-md active:scale-90 transition-all">æ–°å¢</button>
                </div>
                <div id="todo-display" class="space-y-3"></div>
            </div>
        </section>

        <!-- åœ–è¡¨åˆ†æ -->
        <section id="sec-analysis" class="page-section hidden space-y-5">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm text-center">
                <h3 class="font-black text-slate-400 mb-6 uppercase text-[10px] tracking-widest">Expense Chart</h3>
                <div class="relative h-64"><canvas id="mainChart"></canvas></div>
                <div id="analysis-text" class="mt-8 text-xs font-black text-slate-500 bg-slate-50 p-5 rounded-2xl border border-dashed border-slate-200"></div>
            </div>
        </section>
    </main>

    <!-- è¡Œç¨‹å¡«å¯«å½ˆçª— -->
    <div id="it-modal" class="modal-bg" onclick="if(event.target===this)closeM('it-modal')">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-8 space-y-5 animate-up overflow-y-auto max-h-[90vh] no-scrollbar shadow-2xl">
            <div class="flex justify-between items-center">
                <h3 class="font-black text-2xl text-slate-800">å®‰æ’è¦åŠƒ</h3>
                <button onclick="closeM('it-modal')" class="text-slate-300 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 ml-1">æ™‚é–“</label>
                    <input id="it-time" type="time" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none border border-slate-100">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 ml-1">é¡åˆ¥</label>
                    <select id="it-type" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none border border-slate-100">
                        <option value="shrine">â›©ï¸ ç¥ç¤¾</option>
                        <option value="park">ğŸ¡ éŠæ¨‚åœ’</option>
                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                        <option value="spot">ğŸš© æ™¯é»</option>
                        <option value="transit">ğŸšŒ äº¤é€š/åœ°éµ</option>
                        <option value="hotel">ğŸ¨ ä½å®¿</option>
                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                    </select>
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 ml-1">åç¨±</label>
                <input id="it-title" type="text" placeholder="ä¾‹å¦‚ï¼šæ·ºè‰å¯ºã€æ¢…ç”°è—å¤©å¤§å»ˆ" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-black outline-none border border-slate-100">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 ml-1">Googleåœ°åœ–é—œéµå­—</label>
                <input id="it-location" type="text" placeholder="åœ°é»ã€åœ°å€æˆ–åº—å" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none border border-slate-100">
            </div>
            
            <div class="p-5 bg-blue-50/50 rounded-3xl space-y-4 border border-blue-100">
                <p class="text-[10px] font-black text-blue-500 uppercase flex items-center gap-2"><i class="fas fa-train"></i> è½‰ä¹˜è³‡è¨Šèˆ‡é ä¼°è²»ç”¨</p>
                <div class="grid grid-cols-2 gap-3">
                    <input id="it-station" type="text" placeholder="åœ°éµç«™/è·¯ç·š" class="p-3 bg-white rounded-xl text-xs font-bold border-none shadow-sm">
                    <input id="it-duration" type="text" placeholder="æ­ä¹˜æ™‚é–“(åˆ†)" class="p-3 bg-white rounded-xl text-xs font-bold border-none shadow-sm">
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative flex-1">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-300 text-[10px] font-black">JPY</span>
                        <input id="it-cost" type="number" placeholder="è»Šè³‡è²»ç”¨" class="w-full pl-10 p-3 bg-white rounded-xl text-xs font-black text-blue-600 border-none shadow-sm outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="it-sync-bill" class="w-4 h-4 rounded accent-blue-500" checked>
                        <label for="it-sync-bill" class="text-[10px] font-black text-slate-400">è¨˜å¸³åŒæ­¥</label>
                    </div>
                </div>
            </div>

            <textarea id="it-note" placeholder="æœ‰ä»€éº¼è¦æé†’è‡ªå·±çš„å—ï¼Ÿ" class="w-full p-4 bg-slate-50 rounded-2xl text-sm h-24 outline-none border border-slate-100"></textarea>
            <button onclick="saveItinerary()" class="w-full py-5 bg-pink-400 text-white rounded-[1.5rem] font-black text-md shadow-lg active:scale-95 transition-all">å®Œæˆè¨ˆç•«</button>
        </div>
    </div>

    <!-- æ¨™é¡Œä¿®æ”¹å°ˆç”¨å½ˆçª— (ä¿®å¾©é»æ“Šç„¡æ•ˆå•é¡Œ) -->
    <div id="title-modal" class="modal-bg" onclick="if(event.target===this)closeM('title-modal')">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-5 animate-up shadow-2xl mb-20">
            <h3 class="font-black text-xl text-slate-800">ä¿®æ”¹æ—…ç¨‹æ¨™é¡Œ</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 ml-1 uppercase tracking-widest">Main Title</label>
                    <input id="input-main-title" type="text" class="w-full p-4 bg-slate-50 rounded-2xl text-lg font-black outline-none border border-slate-100">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 ml-1 uppercase tracking-widest">Sub Title</label>
                    <input id="input-sub-title" type="text" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold outline-none border border-slate-100">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 ml-1 uppercase tracking-widest">Theme Color</label>
                    <input id="input-theme-color" type="color" class="w-full h-12 bg-slate-50 rounded-2xl p-1 outline-none border border-slate-100">
                </div>
            </div>
            <button onclick="saveTitles()" class="w-full py-4 bg-pink-400 text-white rounded-2xl font-black text-sm shadow-md active:scale-95 transition-all">ç¢ºèªä¿®æ”¹</button>
        </div>
    </div>

    <!-- æˆå“¡ç®¡ç†å½ˆçª— -->
    <div id="member-modal" class="modal-bg" onclick="if(event.target===this)closeM('member-modal')">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-5 animate-up shadow-2xl mb-20">
            <h3 class="font-black text-xl">æˆå“¡åå–®</h3>
            <div class="flex gap-2">
                <input id="member-new-name" type="text" placeholder="è¼¸å…¥å§“å" class="flex-1 p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none">
                <button onclick="addMember()" class="bg-pink-400 text-white px-6 rounded-2xl font-black text-xs shadow-md">æ–°å¢</button>
            </div>
            <div id="member-edit-list" class="max-h-52 overflow-y-auto space-y-2 no-scrollbar px-1"></div>
            <button onclick="closeM('member-modal')" class="w-full py-4 bg-slate-100 rounded-2xl font-bold text-sm text-slate-400">é—œé–‰</button>
        </div>
    </div>

    <script>
        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            themeColor: '#ffb7c5',
            mainTitle: "TOKYO",
            subTitle: "Dreamy Diary",
            selectedDay: 1,
            currency: 'JPY',
            exchangeRate: 0.215,
            members: ["æˆ‘", "å¤¥ä¼´"],
            itinerary: [],
            todos: [],
            bills: [],
            editingBillId: null
        };

        const STORAGE_KEY = 'TRIP_MASTER_GITHUB_PRO_V1';
        const IT_MAP = { shrine: "â›©ï¸ ç¥ç¤¾", park: "ğŸ¡ éŠæ¨‚åœ’", food: "ğŸ´ ç¾é£Ÿ", spot: "ğŸš© æ™¯é»", transit: "ğŸšŒ äº¤é€š", hotel: "ğŸ¨ ä½å®¿", shop: "ğŸ›ï¸ è³¼ç‰©" };
        const CAT_MAP = { food: "ğŸ´ é£²é£Ÿ", transport: "ğŸš— äº¤é€š", hotel: "ğŸ¨ ä½å®¿", shop: "ğŸ›ï¸ è³¼ç‰©", ticket: "ğŸŸï¸ é–€ç¥¨", other: "ğŸ“¦ å…¶ä»–" };
        let chart = null;

        // --- åˆå§‹åŒ–èˆ‡ä¿å­˜ ---
        const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        const load = () => {
            const s = localStorage.getItem(STORAGE_KEY);
            if(s) state = Object.assign(state, JSON.parse(s));
        };

        const closeM = (id) => document.getElementById(id).style.display = 'none';
        const openM = (id) => document.getElementById(id).style.display = 'flex';

        // --- æ ¸å¿ƒæ¸²æŸ“ ---
        const render = () => {
            save();
            
            // æ›´æ–° UI è‰²å½©èˆ‡æ¨™é¡Œ
            document.documentElement.style.setProperty('--primary', state.themeColor);
            document.getElementById('header-bg').style.background = `linear-gradient(135deg, ${state.themeColor}, #ffffff)`;
            document.getElementById('main-title-display').innerText = state.mainTitle;
            document.getElementById('sub-title-display').innerText = state.subTitle;
            document.getElementById('exchange-rate-input').value = state.exchangeRate;

            // å¤©æ•¸åˆ‡æ›å™¨
            document.getElementById('day-bar').innerHTML = Array.from({length: 12}, (_, i) => i + 1).map(d => `
                <button onclick="state.selectedDay=${d};render()" class="day-tab-btn shadow-sm ${state.selectedDay===d?'active':'bg-white text-slate-300'}">Day ${d}</button>
            `).join('');

            // è¡Œç¨‹æ¸…å–®
            const its = state.itinerary.filter(i => i.day === state.selectedDay).sort((a,b)=>a.time.localeCompare(b.time));
            document.getElementById('itinerary-list').innerHTML = its.map(i => {
                const mapLink = i.location ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location)}` : null;
                return `
                <div class="itinerary-card card-${i.type} bg-white p-6 rounded-[2rem] shadow-sm flex gap-4 animate-up">
                    <div class="min-w-[50px] text-center border-r-2 border-slate-50 pr-4">
                        <div class="text-[14px] font-black text-slate-700">${i.time}</div>
                    </div>
                    <div class="flex-1 space-y-2">
                        <div class="text-[15px] font-black text-slate-800">${IT_MAP[i.type] || 'ğŸ“'} ${i.title}</div>
                        ${(i.station || i.duration || i.cost) ? `
                        <div class="flex flex-wrap gap-2 text-[10px] font-black">
                            ${i.station ? `<span class="bg-blue-50 text-blue-500 px-2.5 py-1 rounded-lg border border-blue-100"><i class="fas fa-subway mr-1"></i>${i.station}</span>` : ''}
                            ${i.duration ? `<span class="bg-orange-50 text-orange-500 px-2.5 py-1 rounded-lg border border-orange-100"><i class="fas fa-clock mr-1"></i>${i.duration} åˆ†</span>` : ''}
                            ${i.cost ? `<span class="bg-emerald-50 text-emerald-500 px-2.5 py-1 rounded-lg border border-emerald-100"><i class="fas fa-coins mr-1"></i>${i.cost} JPY</span>` : ''}
                        </div>
                        ` : ''}
                        ${i.location ? `
                            <a href="${mapLink}" target="_blank" class="inline-flex items-center text-[10px] text-sky-500 font-black bg-sky-50 px-2.5 py-1 rounded-lg border border-sky-100 hover:bg-sky-100 transition-colors">
                                <i class="fas fa-map-marked-alt mr-1"></i>æŸ¥çœ‹åœ°åœ–
                            </a>
                        ` : ''}
                        ${i.note ? `<div class="text-[11px] text-slate-400 bg-slate-50 p-3 rounded-2xl italic font-medium">å‚™è¨»: ${i.note}</div>`:''}
                    </div>
                    <button onclick="deleteIt(${i.id})" class="text-slate-200 hover:text-red-300 transition-colors self-start p-1"><i class="fas fa-trash-alt text-xs"></i></button>
                </div>
                `;
            }).join('') || `<div class="py-12 text-center text-slate-300 italic text-xs font-black tracking-widest opacity-50">NO PLANS FOR TODAY âœ¨</div>`;

            // åˆ†å¸³ UI æ›´æ–°
            document.getElementById('bill-payer').innerHTML = state.members.map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('split-display').innerHTML = state.members.map(m => `
                <label class="flex items-center gap-2 bg-slate-50 px-4 py-2.5 rounded-2xl text-[11px] font-black cursor-pointer border-2 border-transparent has-[:checked]:border-pink-200 has-[:checked]:bg-white shadow-sm transition-all">
                    <input type="checkbox" name="split-item" value="${m}" checked class="w-4 h-4 rounded accent-pink-400"> ${m}
                </label>
            `).join('');
            
            document.getElementById('btn-cur-jpy').className = `currency-btn px-4 py-1.5 rounded-lg text-[10px] ${state.currency==='JPY'?'active':'text-slate-400'}`;
            document.getElementById('btn-cur-twd').className = `currency-btn px-4 py-1.5 rounded-lg text-[10px] ${state.currency==='TWD'?'active':'text-slate-400'}`;
            document.getElementById('bill-amount').placeholder = state.currency === 'JPY' ? "æ—¥å¹£é‡‘é¡" : "å°å¹£é‡‘é¡";

            // æ­·å²ç´€éŒ„
            document.getElementById('bill-history').innerHTML = state.bills.slice().reverse().map(b => `
                <div class="bg-white p-5 rounded-[2rem] flex justify-between items-center shadow-sm relative active:scale-[0.98] transition-all border border-slate-50" onclick="editBill(${b.id})">
                    <div class="flex gap-4 items-center">
                        <div class="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-xl shadow-inner">${CAT_MAP[b.category]?.split(' ')[0]}</div>
                        <div>
                            <div class="text-[13px] font-black text-slate-700">${b.desc}</div>
                            <div class="text-[10px] text-slate-400 font-bold">ç”± ${b.payer} æ”¯ä»˜</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="font-black text-pink-500 text-sm">$${Math.round(b.twd)} TWD</div>
                            <div class="text-[10px] text-slate-300 font-black">${b.currency}</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteBill(${b.id})" class="text-slate-200 hover:text-red-400 p-2"><i class="fas fa-trash-alt text-[11px]"></i></button>
                    </div>
                </div>
            `).join('');

            // å¾…è¾¦æ¸²æŸ“
            document.getElementById('todo-display').innerHTML = state.todos.map((t, idx) => `
                <div class="flex items-center justify-between p-5 bg-slate-50 rounded-[1.8rem] border border-white">
                    <div onclick="toggleTodo(${idx})" class="flex items-center gap-4 cursor-pointer">
                        <i class="fas ${t.done?'fa-check-circle text-emerald-400':'fa-circle text-white shadow-inner'} text-2xl"></i>
                        <span class="text-sm ${t.done?'line-through opacity-30 text-slate-400 font-medium':'font-black text-slate-600'}">${t.text}</span>
                    </div>
                    <button onclick="state.todos.splice(${idx},1);render()" class="text-slate-200 px-2"><i class="fas fa-times"></i></button>
                </div>
            `).join('');

            updateSettlement();
        };

        // --- åŠŸèƒ½æ¨¡çµ„ ---
        const switchTab = (id) => {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
            if(id === 'analysis') renderAnalysis();
        };

        const renderAnalysis = () => {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const data = {}; Object.keys(CAT_MAP).forEach(k => data[k] = 0);
            state.bills.forEach(b => data[b.category] += b.twd);
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.values(CAT_MAP), datasets: [{ data: Object.values(data), backgroundColor: ['#ef4444','#3b82f6','#8b5cf6','#ec4899','#fbbf24','#94a3b8'], borderWidth: 4, borderRadius: 10 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20, font: { size: 11, weight: '900' } } } } }
            });
            const total = Object.values(data).reduce((a,b)=>a+b, 0);
            document.getElementById('analysis-text').innerHTML = `ä¼°ç®—ç¸½æ—…è²»ï¼š<span class="text-pink-500 text-lg ml-1 font-black">TWD $${Math.round(total).toLocaleString()}</span>`;
        };

        const updateRate = (v) => { state.exchangeRate = parseFloat(v) || 0.21; render(); };
        const setCurrency = (c) => { state.currency = c; render(); };

        const saveItinerary = () => {
            const title = document.getElementById('it-title').value.trim();
            const time = document.getElementById('it-time').value;
            if(!title || !time) return;
            
            const cost = parseFloat(document.getElementById('it-cost').value);
            const sync = document.getElementById('it-sync-bill').checked;

            state.itinerary.push({
                id: Date.now(), day: state.selectedDay, time, title,
                type: document.getElementById('it-type').value,
                location: document.getElementById('it-location').value,
                station: document.getElementById('it-station').value,
                duration: document.getElementById('it-duration').value,
                cost: cost || 0,
                note: document.getElementById('it-note').value
            });

            if(cost > 0 && sync) {
                state.bills.push({
                    id: Date.now() + 1,
                    amount: cost, desc: `(äº¤é€š) ${title}`, currency: 'JPY',
                    twd: cost * state.exchangeRate,
                    payer: state.members[0], category: 'transport', splitters: [...state.members]
                });
            }
            ['it-title', 'it-location', 'it-station', 'it-duration', 'it-cost', 'it-note'].forEach(id => document.getElementById(id).value = "");
            closeM('it-modal'); render();
        };

        const deleteIt = (id) => { state.itinerary = state.itinerary.filter(i => i.id !== id); render(); };

        const saveBill = () => {
            const amt = parseFloat(document.getElementById('bill-amount').value);
            const desc = document.getElementById('bill-desc').value.trim();
            const sers = Array.from(document.querySelectorAll('input[name="split-item"]:checked')).map(i => i.value);
            if(!amt || !desc || !sers.length) return;

            const billData = {
                id: state.editingBillId || Date.now(),
                amount: amt, desc, currency: state.currency,
                twd: state.currency === 'JPY' ? amt * state.exchangeRate : amt,
                payer: document.getElementById('bill-payer').value,
                category: document.getElementById('bill-category').value,
                splitters: sers
            };

            if(state.editingBillId){
                const idx = state.bills.findIndex(x => x.id === state.editingBillId);
                state.bills[idx] = billData;
            } else { state.bills.push(billData); }
            cancelBillEdit();
        };

        const cancelBillEdit = () => {
            state.editingBillId = null;
            document.getElementById('bill-amount').value = "";
            document.getElementById('bill-desc').value = "";
            document.getElementById('bill-form-title').innerText = "ğŸ’¸ æ–°å¢æ”¯å‡º";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            render();
        };

        const editBill = (id) => {
            const b = state.bills.find(x => x.id === id);
            if(!b) return;
            state.editingBillId = id;
            state.currency = b.currency || 'JPY';
            document.getElementById('bill-amount').value = b.amount;
            document.getElementById('bill-desc').value = b.desc;
            document.getElementById('bill-payer').value = b.payer;
            document.getElementById('bill-category').value = b.category;
            const checks = document.querySelectorAll('input[name="split-item"]');
            checks.forEach(c => c.checked = b.splitters.includes(c.value));
            document.getElementById('bill-form-title').innerText = "âœï¸ ä¿®æ”¹æ”¯å‡ºç´€éŒ„";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            render();
        };

        const deleteBill = (id) => { state.bills = state.bills.filter(b => b.id !== id); if(state.editingBillId === id) cancelBillEdit(); render(); };

        const updateSettlement = () => {
            const balances = {}; state.members.forEach(m => balances[m] = 0);
            state.bills.forEach(b => {
                const sers = b.splitters.filter(s => state.members.includes(s));
                if(!sers.length) return;
                const share = b.twd / sers.length;
                if(balances[b.payer] !== undefined) balances[b.payer] += b.twd;
                sers.forEach(s => balances[s] -= share);
            });
            const d = [], c = [];
            Object.keys(balances).forEach(m => {
                if(balances[m] < -1) d.push({n: m, a: Math.abs(balances[m])});
                else if(balances[m] > 1) c.push({n: m, a: balances[m]});
            });
            const r = []; let i=0, j=0;
            while(i<d.length && j<c.length){
                const p = Math.min(d[i].a, c[j].a);
                r.push(`<span>${d[i].n}</span> <i class="fas fa-arrow-right mx-2 text-[8px] opacity-30"></i> <span>${c[j].n}</span>ï¼š<b class='text-pink-500 font-black ml-1'>$${Math.round(p)}</b>`);
                d[i].a-=p; c[j].a-=p;
                if(d[i].a<1) i++; if(c[j].a<1) j++;
            }
            document.getElementById('settlement-display').innerHTML = r.map(l => `<div class='bg-white p-5 rounded-[1.5rem] text-[11px] font-black text-slate-500 shadow-sm border border-slate-50'>${l}</div>`).join('');
        };

        const addTodo = () => {
            const v = document.getElementById('todo-input').value.trim();
            if(v){ state.todos.push({text: v, done: false}); document.getElementById('todo-input').value=""; render(); }
        };
        const toggleTodo = (idx) => { state.todos[idx].done = !state.todos[idx].done; render(); };

        // --- æˆå“¡èˆ‡æ¨™é¡Œç®¡ç† ---
        const openMemberM = () => {
            const list = document.getElementById('member-edit-list');
            list.innerHTML = state.members.map((m, i) => `
                <div class="flex gap-2 items-center mb-2 bg-slate-50 p-2 rounded-2xl">
                    <input type="text" value="${m}" onchange="state.members[${i}]=this.value;render()" class="flex-1 bg-white px-4 py-3 rounded-xl text-xs font-black outline-none border-none shadow-sm">
                    <button onclick="state.members.splice(${i},1);render();openMemberM()" class="text-red-300 px-4 py-2 hover:text-red-500 transition-colors"><i class="fas fa-user-minus"></i></button>
                </div>
            `).join('');
            openM('member-modal');
        };
        const addMember = () => {
            const n = document.getElementById('member-new-name').value.trim();
            if(n && !state.members.includes(n)){ state.members.push(n); document.getElementById('member-new-name').value=""; render(); openMemberM(); }
        };

        // --- æ¨™é¡Œä¿®æ”¹å°ˆç”¨ ---
        document.getElementById('header-trigger').onclick = (e) => {
            e.preventDefault();
            document.getElementById('input-main-title').value = state.mainTitle;
            document.getElementById('input-sub-title').value = state.subTitle;
            document.getElementById('input-theme-color').value = state.themeColor;
            openM('title-modal');
        };

        const saveTitles = () => {
            state.mainTitle = document.getElementById('input-main-title').value.trim() || "Tokyo";
            state.subTitle = document.getElementById('input-sub-title').value.trim() || "Travel Diary";
            state.themeColor = document.getElementById('input-theme-color').value;
            closeM('title-modal');
            render();
        };

        // --- å‚™ä»½é‚„åŸ ---
        const exportData = () => {
            const b = new Blob([JSON.stringify(state)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `TripMaster_${state.mainTitle}.json`; a.click();
        };
        const importData = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => { try { state = JSON.parse(ev.target.result); render(); } catch(err) { alert("è®€å–å¤±æ•—"); } };
            r.readAsText(f);
        };
        const resetSystem = () => {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ")){
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        // --- å•Ÿå‹• ---
        window.onload = () => {
            load();
            render();
        };
    </script>
</body>
</html>
